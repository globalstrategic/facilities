{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Facility",
  "description": "Schema for mining and processing facility data. Enhanced with EntityIdentity integration for improved company resolution, metal normalization, and facility cross-referencing. See docs/ENTITYIDENTITY_INTEGRATION_PLAN.md for details.",
  "version": "2.1.0",
  "lastUpdated": "2025-10-30",
  "type": "object",
  "required": ["facility_id", "name", "country_iso3", "types", "verification"],
  "properties": {
    "ei_facility_id": {
      "type": ["string", "null"],
      "pattern": "^[a-z0-9_]+$",
      "description": "EntityIdentity facility ID for cross-referencing with entityidentity database (e.g., 'mimosa_52f2f3d6')"
    },
    "facility_id": {
      "type": "string",
      "pattern": "^[a-z]{3}-[a-z0-9-]+-fac$",
      "description": "Unique facility identifier in format: iso3-slug-fac"
    },
    "name": {
      "type": "string",
      "minLength": 1,
      "description": "Primary facility name (legacy field, prefer canonical_name for new code)"
    },
    "canonical_name": {
      "type": ["string", "null"],
      "minLength": 1,
      "description": "Canonical facility name in format: {Town} {Operator} {Core} {Type} (e.g., 'Roxby Downs BHP Olympic Dam Mine'). Unicode-aware, supports diacritics and non-Latin scripts. Operator included if operator_display is set. Used for human-readable EntityIdentity resolution."
    },
    "canonical_slug": {
      "type": ["string", "null"],
      "pattern": "^[a-z0-9]+(?:-[a-z0-9]+)*$",
      "description": "Machine-safe canonical identifier (ASCII lowercase, hyphenated). EXCLUDES operator for stability through operator churn. Generated from {town}-{core}-{primary_type} via transliteration. Used for joins, URLs, and programmatic access."
    },
    "display_name": {
      "type": ["string", "null"],
      "description": "Short display name for UI (core name without town/operator/type). Auto-generated from canonical_name unless display_name_override is true."
    },
    "display_name_override": {
      "type": "boolean",
      "default": false,
      "description": "If true, display_name was manually curated and should not be auto-regenerated."
    },
    "display_name_source": {
      "type": "string",
      "enum": ["auto", "manual"],
      "default": "auto",
      "description": "Source of display_name: 'auto' (generated) or 'manual' (hand-curated)."
    },
    "aliases": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Alternative names for the facility"
    },
    "country_iso3": {
      "type": "string",
      "pattern": "^[A-Z]{3}$",
      "description": "ISO 3166-1 alpha-3 country code"
    },
    "location": {
      "type": "object",
      "properties": {
        "lat": {
          "type": ["number", "null"],
          "minimum": -90,
          "maximum": 90,
          "description": "Latitude in decimal degrees"
        },
        "lon": {
          "type": ["number", "null"],
          "minimum": -180,
          "maximum": 180,
          "description": "Longitude in decimal degrees"
        },
        "precision": {
          "type": "string",
          "enum": ["exact", "site", "approximate", "region", "unknown"],
          "description": "Accuracy of geographic coordinates"
        },
        "town": {
          "type": ["string", "null"],
          "description": "Nearest town or city name. Used in canonical_name. Null if missing (do not use 'TODO' sentinel). Deterministic selection: town > city > municipality > village > hamlet."
        },
        "town_ascii": {
          "type": ["string", "null"],
          "description": "ASCII transliteration of town name for non-Latin scripts (BGN/PCGN standard). Used in canonical_slug generation."
        },
        "region": {
          "type": ["string", "null"],
          "description": "State, province, or region name (optional)"
        },
        "geohash": {
          "type": ["string", "null"],
          "pattern": "^[0-9b-hjkmnp-z]{1,12}$",
          "description": "Geohash encoding of coordinates (precision 6-8 chars). Used for proximity queries and duplicate detection."
        },
        "town_resolution_strategy": {
          "type": ["string", "null"],
          "enum": ["name_extraction", "industrial_zone", "reverse_geocode", "manual", "mining_district", null],
          "description": "How location.town was resolved. Aids auditability and re-enrichment."
        }
      },
      "required": ["precision"]
    },
    "types": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": ["mine", "smelter", "refinery", "concentrator", "plant", "mill", "heap_leach", "tailings", "exploration", "development", "hydromet_plant", "rolling_mill", "steel_plant", "battery_recycling", "processing_plant"]
      },
      "minItems": 1,
      "description": "Facility operation types (legacy field, may contain uncleaned data)"
    },
    "primary_type": {
      "type": ["string", "null"],
      "enum": ["mine", "smelter", "refinery", "concentrator", "plant", "mill", "heap_leach", "tailings", "exploration", "development", "hydromet_plant", "rolling_mill", "steel_plant", "battery_recycling", "processing_plant", null],
      "description": "Primary facility type (cleaned and validated). Used in canonical_name generation. Prefer over types[0]."
    },
    "type_confidence": {
      "type": ["number", "null"],
      "minimum": 0,
      "maximum": 1,
      "description": "Confidence score for primary_type classification (0-1). Null if type uncertain."
    },
    "commodities": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "metal": {
            "type": "string",
            "description": "Normalized metal/commodity name"
          },
          "primary": {
            "type": "boolean",
            "description": "Whether this is the primary commodity"
          },
          "chemical_formula": {
            "type": ["string", "null"],
            "pattern": "^[A-Z][a-z]?[0-9]*([A-Z][a-z]?[0-9]*)*$",
            "description": "Chemical formula or symbol (e.g., 'Cu', 'Fe2O3', 'PGM'). Pattern allows basic chemical formulas."
          },
          "category": {
            "type": ["string", "null"],
            "enum": ["base_metal", "precious_metal", "rare_earth", "industrial_mineral", "energy", "construction", "fertilizer", "unknown", null],
            "description": "Metal category classification for grouping and analysis"
          }
        },
        "required": ["metal", "primary"]
      },
      "description": "Metals and commodities produced. Enhanced with chemical formulas and categories via entityidentity integration."
    },
    "status": {
      "type": "string",
      "enum": ["operating", "planned", "construction", "care_and_maintenance", "closed", "suspended", "unknown"],
      "description": "Current operational status"
    },
    "owner_links": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "company_id": {
            "type": "string",
            "pattern": "^cmp-[a-z0-9-]+$",
            "description": "Canonical company identifier"
          },
          "role": {
            "type": "string",
            "enum": ["owner", "joint_venture", "minority_owner"],
            "description": "Ownership role"
          },
          "percentage": {
            "type": ["number", "null"],
            "minimum": 0,
            "maximum": 100,
            "description": "Ownership percentage"
          },
          "confidence": {
            "type": "number",
            "minimum": 0,
            "maximum": 1,
            "description": "Confidence score for this link"
          }
        },
        "required": ["company_id", "role"]
      },
      "description": "Ownership information"
    },
    "operator_link": {
      "type": ["object", "null"],
      "properties": {
        "company_id": {
          "type": "string",
          "pattern": "^cmp-[a-z0-9-]+$",
          "description": "Canonical company identifier"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Confidence score for this link"
        }
      },
      "required": ["company_id"],
      "description": "Operating company information (single current operator). For JVs/multiple operators, use operators[] array."
    },
    "operators": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "company_id": {
            "type": "string",
            "pattern": "^cmp-[a-z0-9-]+$",
            "description": "Canonical company identifier"
          },
          "role": {
            "type": "string",
            "enum": ["operator", "owner", "joint_venture", "managing_partner"],
            "description": "Operational role"
          },
          "share": {
            "type": ["number", "null"],
            "minimum": 0,
            "maximum": 100,
            "description": "Ownership/operational share percentage"
          },
          "start_date": {
            "type": ["string", "null"],
            "format": "date",
            "description": "Start date of operational role (YYYY-MM-DD)"
          },
          "end_date": {
            "type": ["string", "null"],
            "format": "date",
            "description": "End date of operational role (YYYY-MM-DD). Null if current."
          },
          "confidence": {
            "type": "number",
            "minimum": 0,
            "maximum": 1,
            "description": "Confidence score for this link"
          }
        },
        "required": ["company_id", "role"],
        "description": "Operator entry with temporal tracking"
      },
      "description": "All operators (current and historical). Supports JVs and operator churn."
    },
    "operator_display": {
      "type": ["string", "null"],
      "description": "Derived display string for current operator(s). Used in canonical_name. Auto-generated from operators[] if not manually set. For JVs: 'CompanyA-CompanyB JV'."
    },
    "products": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "stream": {
            "type": "string",
            "description": "Product stream name"
          },
          "capacity": {
            "type": ["number", "null"],
            "description": "Production capacity"
          },
          "unit": {
            "type": ["string", "null"],
            "description": "Unit of measurement"
          },
          "year": {
            "type": ["integer", "null"],
            "description": "Year of capacity data"
          }
        },
        "required": ["stream"]
      },
      "description": "Production streams and capacity"
    },
    "sources": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string",
            "enum": ["mines_csv", "gemini_research", "wikipedia", "linkedin", "lei", "manual", "web"],
            "description": "Source type"
          },
          "id": {
            "type": "string",
            "description": "Source identifier"
          },
          "url": {
            "type": "string",
            "format": "uri",
            "description": "Source URL"
          },
          "row": {
            "type": "integer",
            "description": "CSV row number (for mines_csv type)"
          },
          "date": {
            "type": "string",
            "format": "date-time",
            "description": "Date of source data"
          }
        },
        "required": ["type"],
        "anyOf": [
          {"required": ["id"]},
          {"required": ["url"]},
          {"required": ["row"]}
        ]
      },
      "description": "Data sources and references"
    },
    "verification": {
      "type": "object",
      "properties": {
        "status": {
          "type": "string",
          "enum": ["csv_imported", "llm_suggested", "llm_verified", "human_verified", "conflicting"],
          "description": "Verification status"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Overall confidence score"
        },
        "last_checked": {
          "type": "string",
          "format": "date-time",
          "description": "Last verification timestamp"
        },
        "checked_by": {
          "type": "string",
          "description": "Entity or system that performed verification"
        },
        "notes": {
          "type": "string",
          "description": "Additional verification notes"
        }
      },
      "required": ["status", "confidence", "last_checked"]
    },
    "data_quality": {
      "type": "object",
      "properties": {
        "flags": {
          "type": "object",
          "properties": {
            "town_missing": {
              "type": "boolean",
              "description": "True if location.town is null and needs enrichment"
            },
            "type_uncertain": {
              "type": "boolean",
              "description": "True if primary_type classification has low confidence (<0.7)"
            },
            "operator_unresolved": {
              "type": "boolean",
              "description": "True if operator_display is null despite company_mentions present"
            },
            "coordinates_missing": {
              "type": "boolean",
              "description": "True if lat/lon are null"
            },
            "canonical_name_incomplete": {
              "type": "boolean",
              "description": "True if canonical_name is missing required components (town, operator, or type)"
            }
          },
          "description": "Structured data quality flags. Replace 'TODO' sentinels."
        },
        "canonicalization_confidence": {
          "type": ["number", "null"],
          "minimum": 0,
          "maximum": 1,
          "description": "Confidence score for canonical_name generation (0-1). Factors: town resolution, operator resolution, type cleaning."
        }
      },
      "description": "Data quality tracking and flags"
    },
    "canonical_name_history": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "description": "Previous canonical name"
          },
          "from": {
            "type": "string",
            "format": "date-time",
            "description": "Start date of this name"
          },
          "to": {
            "type": "string",
            "format": "date-time",
            "description": "End date of this name"
          },
          "reason": {
            "type": "string",
            "enum": ["operator_change", "town_correction", "type_correction", "rebranding", "data_correction"],
            "description": "Reason for name change"
          }
        },
        "required": ["name", "from", "to", "reason"]
      },
      "description": "History of canonical name changes. Preserves auditability when operators change or data is corrected."
    }
  }
}